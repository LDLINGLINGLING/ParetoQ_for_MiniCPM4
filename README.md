# ParetoQ - æä½æ¯”ç‰¹LLMé‡åŒ–è®­ç»ƒæ¡†æ¶

## é¡¹ç›®ç®€ä»‹

ParetoQ æ˜¯ä¸€ä¸ªç”¨äºå¤§è¯­è¨€æ¨¡å‹(LLM)æä½æ¯”ç‰¹é‡åŒ–è®­ç»ƒçš„ç»Ÿä¸€æ¡†æ¶ã€‚è¯¥é¡¹ç›®æ”¯æŒ 1-bitã€1.58-bitã€2-bitã€3-bit å’Œ 4-bit ç­‰å¤šç§é‡åŒ–ä½æ•°ï¼Œæ—¨åœ¨æ˜¾è‘—å‡å°‘æ¨¡å‹å‚æ•°å¤§å°å’Œè®¡ç®—å¤æ‚åº¦ï¼ŒåŒæ—¶ä¿æŒè¾ƒå¥½çš„æ¨¡å‹æ€§èƒ½ã€‚

æœ¬é¡¹ç›®ç‰¹åˆ«é’ˆå¯¹ **MiniCPM4** æ¨¡å‹è¿›è¡Œäº†ä¼˜åŒ–ï¼Œæä¾›äº†å®Œæ•´çš„é‡åŒ–è®­ç»ƒæµç¨‹ï¼ŒåŒ…æ‹¬æ¨¡å‹åŠ è½½ã€æƒé‡é‡åŒ–ã€è®­ç»ƒå’Œè¯„ä¼°ç­‰åŠŸèƒ½ã€‚

## ä¸»è¦ç‰¹æ€§

- ğŸš€ **å¤šä½é‡åŒ–æ”¯æŒ**: æ”¯æŒ1-4ä½çš„çµæ´»é‡åŒ–é…ç½®
- ğŸ”§ **MiniCPMä¸“ç”¨**: é’ˆå¯¹MiniCPMæ¨¡å‹æ¶æ„æ·±åº¦ä¼˜åŒ–
- ğŸ’¾ **å†…å­˜é«˜æ•ˆ**: é€šè¿‡é‡åŒ–å¤§å¹…å‡å°‘GPUå†…å­˜ä½¿ç”¨
- âš¡ **è®­ç»ƒåŠ é€Ÿ**: æ”¯æŒDeepSpeedåˆ†å¸ƒå¼è®­ç»ƒåŠ é€Ÿ
- ğŸ“Š **å®Œæ•´æµç¨‹**: ä»æ•°æ®é¢„å¤„ç†åˆ°æ¨¡å‹è¯„ä¼°çš„ç«¯åˆ°ç«¯è§£å†³æ–¹æ¡ˆ
- ğŸ› ï¸ **æ˜“äºä½¿ç”¨**: æä¾›è„šæœ¬åŒ–éƒ¨ç½²å’Œè°ƒè¯•æ¨¡å¼
- ğŸ¯ **åˆ†ç»„é‡åŒ–**: æ”¯æŒæƒé‡åˆ†ç»„é‡åŒ–ï¼Œæé«˜é‡åŒ–ç²¾åº¦å’Œçµæ´»æ€§

## ç³»ç»Ÿè¦æ±‚

### ç¡¬ä»¶è¦æ±‚
- GPU: æ”¯æŒCUDAçš„GPUï¼ˆæ¨è8GBä»¥ä¸Šæ˜¾å­˜ï¼‰
- å†…å­˜: 16GBä»¥ä¸Šç³»ç»Ÿå†…å­˜
- å­˜å‚¨: è‡³å°‘50GBå¯ç”¨å­˜å‚¨ç©ºé—´

### è½¯ä»¶è¦æ±‚
- Python 3.8+
- CUDA 11.0+
- Linuxæ“ä½œç³»ç»Ÿï¼ˆæ¨èUbuntu 18.04+ï¼‰

## å®‰è£…æŒ‡å—

### 1. å…‹éš†é¡¹ç›®
```bash
git clone https://github.com/LDLINGLINGLING/ParetoQ_for_MiniCPM4.git
cd /your/path/ParetoQ_for_MiniCPM4
```

### 2. å®‰è£…ä¾èµ–
```bash
pip install -r ParetoQ-main/requirement.txt
```

æ ¸å¿ƒä¾èµ–åŒ…æ‹¬ï¼š
- `transformers==4.48.3` - Hugging Faceå˜æ¢å™¨åº“
- `torch>=2.0.0` - PyTorchæ·±åº¦å­¦ä¹ æ¡†æ¶
- `accelerate>=0.26.0` - è®­ç»ƒåŠ é€Ÿåº“
- `datasets==2.20.0` - æ•°æ®é›†å¤„ç†
- `sentencepiece` - åˆ†è¯å™¨
- `tensorboardX` - è®­ç»ƒå¯è§†åŒ–

### 3. å¯é€‰ï¼šå®‰è£…DeepSpeedï¼ˆæ¨èï¼‰
```bash
pip install deepspeed
```

## é¡¹ç›®ç»“æ„

```
/root/autodl-tmp/
â”œâ”€â”€ ParetoQ-main/                 # ä¸»é¡¹ç›®ç›®å½•
â”‚   â”œâ”€â”€ train_minicpm.py         # ä¸»è®­ç»ƒè„šæœ¬
â”‚   â”œâ”€â”€ run_train_minicpm.sh     # è®­ç»ƒå¯åŠ¨è„šæœ¬
â”‚   â”œâ”€â”€ models/                  # æ¨¡å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ configuration_minicpm.py
â”‚   â”‚   â”œâ”€â”€ modeling_minicpm.py
â”‚   â”‚   â””â”€â”€ utils_quant.py
â”‚   â”œâ”€â”€ utils/                   # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ datautils.py
â”‚   â”‚   â”œâ”€â”€ process_args.py
â”‚   â”‚   â””â”€â”€ utils.py
â”‚   â””â”€â”€ training_dataset_example.jsonl
â”œâ”€â”€ MiniCPM4-0_5B/              # åŸå§‹æ¨¡å‹
â”œâ”€â”€ Minicpm_quant/              # é‡åŒ–åæ¨¡å‹è¾“å‡º
â”œâ”€â”€ output/                     # è®­ç»ƒè¾“å‡º
â”œâ”€â”€ cache/                      # ç¼“å­˜ç›®å½•
â””â”€â”€ logs/                       # è®­ç»ƒæ—¥å¿—
```

## ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿå¼€å§‹

1. **å‡†å¤‡æ¨¡å‹å’Œæ•°æ®**
   ç¡®ä¿ä»¥ä¸‹ç›®å½•å­˜åœ¨ï¼š
   - `/root/autodl-tmp/MiniCPM4-0_5B/` - åŒ…å«åŸå§‹MiniCPMæ¨¡å‹
   - `/root/autodl-tmp/ParetoQ-main/training_dataset_example.jsonl` - è®­ç»ƒæ•°æ®

2. **è¿è¡Œè®­ç»ƒ**
   ```bash
   cd /root/autodl-tmp
   bash run_train_minicpm.sh
   ```

### è¯¦ç»†é…ç½®

#### è®­ç»ƒå‚æ•°é…ç½®

ä¸»è¦è®­ç»ƒå‚æ•°å¯ä»¥åœ¨ `run_train_minicpm.sh` ä¸­ä¿®æ”¹ï¼š

```bash
# é‡åŒ–é…ç½®
--w_bits 4                      # é‡åŒ–ä½æ•° (1,2,3,4)
--contain_weight_clip_val False  # æ˜¯å¦åŒ…å«æƒé‡è£å‰ªå€¼

# æ•°æ®é…ç½®
--model_max_length 2048         # æœ€å¤§åºåˆ—é•¿åº¦
--per_device_train_batch_size 1 # æ¯è®¾å¤‡è®­ç»ƒæ‰¹æ¬¡å¤§å°
--gradient_accumulation_steps 8 # æ¢¯åº¦ç´¯ç§¯æ­¥æ•°

# è®­ç»ƒé…ç½®  
--num_train_epochs 3            # è®­ç»ƒè½®æ•°
--learning_rate 5e-5            # å­¦ä¹ ç‡
--warmup_steps 100              # é¢„çƒ­æ­¥æ•°
--save_steps 500                # ä¿å­˜é—´éš”
--eval_steps 500                # è¯„ä¼°é—´éš”
```

#### è°ƒè¯•æ¨¡å¼

é¡¹ç›®æ”¯æŒè°ƒè¯•æ¨¡å¼ï¼Œæ— éœ€å‘½ä»¤è¡Œå‚æ•°å³å¯è¿è¡Œï¼š

```python
# ç›´æ¥è¿è¡ŒPythonè„šæœ¬è¿›è¡Œè°ƒè¯•
cd /root/autodl-tmp/ParetoQ-main
python train_minicpm.py
```

è°ƒè¯•æ¨¡å¼ä¼šä½¿ç”¨é¢„è®¾çš„é»˜è®¤å‚æ•°ï¼Œä¾¿äºå¼€å‘å’Œæµ‹è¯•ã€‚

### æ•°æ®æ ¼å¼

è®­ç»ƒæ•°æ®é‡‡ç”¨JSONLæ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ªJSONå¯¹è±¡ï¼š

```json
{"text": "è¿™æ˜¯ä¸€ä¸ªè®­ç»ƒæ ·æœ¬çš„æ–‡æœ¬å†…å®¹"}
{"text": "è¿™æ˜¯å¦ä¸€ä¸ªè®­ç»ƒæ ·æœ¬"}
```

### é‡åŒ–ä½æ•°è¯´æ˜

- **1-bit**: ä½¿ç”¨æƒé‡ç»å¯¹å€¼å‡å€¼ä½œä¸ºç¼©æ”¾å› å­
- **2-bit**: ä½¿ç”¨æƒé‡ç»å¯¹å€¼æœ€å¤§å€¼ä½œä¸ºç¼©æ”¾å› å­  
- **3-bit/4-bit**: åŸºäºé‡åŒ–èŒƒå›´è®¡ç®—ç¼©æ”¾å› å­

ä¸åŒä½æ•°çš„é‡åŒ–ç­–ç•¥åœ¨ä»£ç ä¸­è‡ªåŠ¨å¤„ç†ï¼Œç”¨æˆ·åªéœ€æŒ‡å®š `w_bits` å‚æ•°ã€‚

## è¾“å‡ºè¯´æ˜

### æ¨¡å‹è¾“å‡º
- **é‡åŒ–æ¨¡å‹**: ä¿å­˜åœ¨ `/root/autodl-tmp/models/minicpm_quantized/`
- **æ£€æŸ¥ç‚¹**: ä¿å­˜åœ¨ `/root/autodl-tmp/output/checkpoint-*/`

### è®­ç»ƒæ—¥å¿—
- **TensorBoardæ—¥å¿—**: `/root/autodl-tmp/logs/`
- **è®­ç»ƒæŒ‡æ ‡**: `/root/autodl-tmp/output/all_results.json`
- **è¯„ä¼°ç»“æœ**: `/root/autodl-tmp/output/eval_results.json`

## æ€§èƒ½ç›‘æ§

è®­ç»ƒè¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ç›‘æ§ï¼š

```bash
# æŸ¥çœ‹GPUä½¿ç”¨æƒ…å†µ
nvidia-smi

# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tail -f /root/autodl-tmp/logs/events.out.tfevents.*

# å¯åŠ¨TensorBoardï¼ˆå¯é€‰ï¼‰
tensorboard --logdir=/root/autodl-tmp/logs
```

## å¸¸è§é—®é¢˜

### Q: è®­ç»ƒæ—¶å‡ºç°æ˜¾å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
A: å¯ä»¥è°ƒæ•´ä»¥ä¸‹å‚æ•°ï¼š
- å‡å°‘ `per_device_train_batch_size`
- å¢åŠ  `gradient_accumulation_steps` 
- å‡å°‘ `model_max_length`
- ä½¿ç”¨æ›´ä½çš„é‡åŒ–ä½æ•°

### Q: å¦‚ä½•ä½¿ç”¨è‡ªå·±çš„æ•°æ®é›†ï¼Ÿ
A: å°†æ•°æ®è½¬æ¢ä¸ºJSONLæ ¼å¼ï¼Œå¹¶ä¿®æ”¹è„šæœ¬ä¸­çš„æ•°æ®è·¯å¾„ï¼š
```bash
--train_data_local_path "your_data.jsonl"
--eval_data_local_path "your_eval_data.jsonl"
```

### Q: æ”¯æŒå“ªäº›MiniCPMæ¨¡å‹ï¼Ÿ
A: ç†è®ºä¸Šæ”¯æŒæ‰€æœ‰MiniCPMæ¶æ„çš„æ¨¡å‹ï¼Œéœ€è¦ç¡®ä¿æ¨¡å‹é…ç½®æ–‡ä»¶å…¼å®¹ã€‚

### Q: å¦‚ä½•æ¢å¤ä¸­æ–­çš„è®­ç»ƒï¼Ÿ
A: è®­ç»ƒä¼šè‡ªåŠ¨ä¿å­˜æ£€æŸ¥ç‚¹ï¼Œé‡æ–°è¿è¡Œè„šæœ¬ä¼šä»æœ€æ–°æ£€æŸ¥ç‚¹æ¢å¤ã€‚

## æŠ€æœ¯åŸç†

ParetoQé‡‡ç”¨ä»¥ä¸‹æŠ€æœ¯å®ç°é«˜æ•ˆçš„é‡åŒ–è®­ç»ƒï¼š

1. **æƒé‡é‡åŒ–**: å°†å…¨ç²¾åº¦æƒé‡é‡åŒ–åˆ°æŒ‡å®šä½æ•°
2. **æ¢¯åº¦ç¼©æ”¾**: è‡ªåŠ¨è®¡ç®—å’Œåº”ç”¨æƒé‡ç¼©æ”¾å› å­
3. **å†…å­˜ä¼˜åŒ–**: ä½¿ç”¨ä½CPUå†…å­˜æ¨¡å¼åŠ è½½æ¨¡å‹
4. **æ··åˆç²¾åº¦**: æ”¯æŒbfloat16è®­ç»ƒåŠ é€Ÿ

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤Issueå’ŒPull Requestæ¥æ”¹è¿›é¡¹ç›®ã€‚è¯·ç¡®ä¿ï¼š

1. ä»£ç ç¬¦åˆé¡¹ç›®é£æ ¼
2. æ·»åŠ å¿…è¦çš„æµ‹è¯•å’Œæ–‡æ¡£
3. æäº¤å‰è¿è¡Œç°æœ‰æµ‹è¯•

## è®¸å¯è¯

æœ¬é¡¹ç›®åŸºäºBSDè®¸å¯è¯å¼€æºï¼Œè¯¦è§LICENSEæ–‡ä»¶ã€‚

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š
- æäº¤GitHub Issue
- å‘é€é‚®ä»¶è‡³é¡¹ç›®ç»´æŠ¤è€…

---

**æ³¨æ„**: æœ¬é¡¹ç›®ä¸“ä¸ºç ”ç©¶å’Œæ•™è‚²ç›®çš„è®¾è®¡ï¼Œè¯·åˆç†ä½¿ç”¨è®¡ç®—èµ„æºï¼Œéµå®ˆç›¸å…³æ³•å¾‹æ³•è§„ã€‚
